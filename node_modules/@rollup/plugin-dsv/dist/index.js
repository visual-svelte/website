'use strict';

var path = require('path');
var d3Dsv = require('d3-dsv');
var toSource = require('tosource');
var pluginutils = require('@rollup/pluginutils');

function _interopDefaultLegacy (e) { return e && typeof e === 'object' && 'default' in e ? e : { 'default': e }; }

var toSource__default = /*#__PURE__*/_interopDefaultLegacy(toSource);

const parsers = { '.csv': d3Dsv.csvParse, '.tsv': d3Dsv.tsvParse };

function dsv(options = {}) {
  const filter = pluginutils.createFilter(options.include, options.exclude);

  return {
    name: 'dsv',

    transform(code, id) {
      if (!filter(id)) return null;

      const ext = path.extname(id);
      if (!(ext in parsers)) return null;

      let rows = parsers[ext](code);

      if (options.processRow) {
        rows = rows.map((row) => options.processRow(row, id) || row);
      }

      return {
        code: `export default ${toSource__default['default'](rows)};`,
        map: { mappings: '' }
      };
    }
  };
}

module.exports = dsv;
